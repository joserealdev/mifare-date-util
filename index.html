<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#1e40af" />
    <meta
      name="description"
      content="A tool to encode and decode the custom date/time format from Mifare Classic card data"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-title" content="Mifare Encoder" />
    <link rel="manifest" href="/manifest.json" />
    <link
      rel="icon"
      type="image/svg+xml"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%231e40af' width='192' height='192'/><text x='50%' y='50%' font-size='80' font-weight='bold' fill='white' text-anchor='middle' dominant-baseline='middle'>MD</text></svg>"
    />
    <title>Mifare Classic Date Encoder/Decoder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .card {
        background-color: #ffffff;
        border: 1px solid #e2e8f0;
        box-shadow:
          0 4px 6px -1px rgb(0 0 0 / 0.1),
          0 2px 4px -2px rgb(0 0 0 / 0.1);
      }
    </style>
  </head>
  <body class="bg-gray-50 text-gray-800">
    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
      <header class="text-center mb-8">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-900">
          Mifare Classic Date Encoder & Decoder
        </h1>
        <p class="mt-2 text-lg text-gray-600">
          A tool to encode and decode the custom date/time format from Mifare
          Classic card data.
        </p>
      </header>

      <!-- Decoder Section -->
      <div class="card rounded-xl p-6 md:p-8 mb-10">
        <h2 class="text-2xl font-semibold mb-4 text-center">Decoder</h2>
        <p class="text-center text-gray-600 mb-4">
          Enter a 32-character hex block to decode the date and time.
        </p>
        <div class="flex flex-col md:flex-row gap-4 items-center">
          <input
            type="text"
            id="hexInput"
            class="w-full px-4 py-3 bg-gray-100 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition duration-300"
            placeholder="e.g., 193A477C180152803900FA00DC000000"
          />
          <button
            onclick="decodeAndDisplay()"
            class="w-full md:w-auto bg-blue-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-105"
          >
            Decode
          </button>
        </div>
        <div
          id="result"
          class="mt-6 text-center text-xl font-medium text-gray-700 h-8"
        ></div>
        <div
          id="error"
          class="mt-4 text-center text-lg font-medium text-red-600 h-6"
        ></div>
      </div>

      <!-- Encoder Section -->
      <div class="card rounded-xl p-6 md:p-8">
        <h2 class="text-2xl font-semibold mb-4 text-center">Encoder</h2>
        <p class="text-center text-gray-600 mb-4">
          Select a date and time to generate the 8-character hex code.
        </p>
        <div class="flex flex-col md:flex-row gap-4 items-center">
          <input
            type="datetime-local"
            id="dateInput"
            class="w-full px-4 py-3 bg-gray-100 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition duration-300"
          />
          <button
            onclick="setCurrentTime()"
            class="w-full md:w-auto bg-gray-500 text-white font-semibold px-6 py-3 rounded-lg hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition-transform transform hover:scale-105"
          >
            Now
          </button>
          <button
            onclick="encodeAndDisplay()"
            class="w-full md:w-auto bg-green-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-transform transform hover:scale-105"
          >
            Encode
          </button>
        </div>
        <div
          id="encodedResult"
          class="mt-6 text-center text-xl font-mono text-gray-700 h-8"
        ></div>
        <div
          id="encodeError"
          class="mt-4 text-center text-lg font-medium text-red-600 h-6"
        ></div>
      </div>

      <div class="mt-10">
        <h2 class="text-2xl font-semibold text-center mb-4">How It Works</h2>
        <div class="bg-white rounded-lg p-6 border border-gray-200">
          <p class="mb-4">
            The date and time are encoded into the first 4 bytes (8 hex
            characters) of the 16-byte block. The process uses little-endian
            byte order and custom bitfields.
          </p>
          <div class="grid md:grid-cols-2 gap-8">
            <div>
              <h3 class="font-semibold text-lg mb-2">
                Date Encoding (Bytes 0 & 1)
              </h3>
              <p class="mb-4">Stored in a 16-bit word (B1 then B0):</p>
              <pre
                class="bg-gray-100 p-3 rounded-md text-sm"
              ><code>DDDDDMMMMYYYYYYY</code></pre>
              <ul class="list-disc list-inside mt-2 space-y-1">
                <li><strong>Day (DDDDD):</strong> 5 bits (1-31).</li>
                <li><strong>Month (MMMM):</strong> 4 bits (1-12).</li>
                <li><strong>Year (YYYYYYY):</strong> 7 bits (year % 100).</li>
              </ul>
            </div>
            <div>
              <h3 class="font-semibold text-lg mb-2">
                Time Encoding (Bytes 2 & 3)
              </h3>
              <p class="mb-4">Stored in a 16-bit word (B3 then B2):</p>
              <pre
                class="bg-gray-100 p-3 rounded-md text-sm"
              ><code>?????MMMMMMHHHHH</code></pre>
              <ul class="list-disc list-inside mt-2 space-y-1">
                <li><strong>Hour (HHHHH):</strong> 5 bits (0-23).</li>
                <li><strong>Minute (MMMMMM):</strong> 6 bits (0-59).</li>
                <li>The top 5 bits are unused.</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-10">
        <h2 class="text-2xl font-semibold text-center mb-4">Test Cases</h2>
        <div class="grid md:grid-cols-2 gap-4">
          <div class="bg-white p-4 rounded-lg border">
            <p class="font-mono text-sm break-all">
              193A477C180152803900FA00DC000000
            </p>
            <p class="font-semibold mt-1">→ 07/04/2025 07:34</p>
          </div>
          <div class="bg-white p-4 rounded-lg border">
            <p class="font-mono text-sm break-all">
              1951EA7A280050002B007D00B3000000
            </p>
            <p class="font-semibold mt-1">→ 10/02/2025 10:23</p>
          </div>
          <div class="bg-white p-4 rounded-lg border">
            <p class="font-mono text-sm break-all">
              99E9EC7ED00010006C803E0039000000
            </p>
            <p class="font-semibold mt-1">→ 29/03/2025 12:55</p>
          </div>
          <div class="bg-white p-4 rounded-lg border">
            <p class="font-mono text-sm break-all">
              99B34C40861C008000401F0000000000
            </p>
            <p class="font-semibold mt-1">→ 22/07/2025 12:02</p>
          </div>
          <div class="bg-white p-4 rounded-lg border">
            <p class="font-mono text-sm break-all">
              223B875D180152803900FA00DC000000
            </p>
            <p class="font-semibold mt-1">→ 07/06/1934 07:44</p>
          </div>
        </div>
      </div>
    </div>

    <script>
      /**
       * Decodes a date and time from a 32-character Mifare Classic hex string.
       * @param {string} hex - The 32-character hex string.
       * @returns {string|null} The formatted date string or null on error.
       */
      function decodeMifareDate(hex) {
        if (
          !hex ||
          typeof hex !== "string" ||
          hex.length !== 32 ||
          !/^[0-9a-fA-F]+$/.test(hex)
        ) {
          console.error("Invalid input: Must be a 32-character hex string.");
          return null;
        }

        const b0 = parseInt(hex.substring(0, 2), 16);
        const b1 = parseInt(hex.substring(2, 4), 16);
        const b2 = parseInt(hex.substring(4, 6), 16);
        const b3 = parseInt(hex.substring(6, 8), 16);

        const dateWord = (b1 << 8) | b0;
        const day = (dateWord >> 11) & 0x1f;
        const month = (dateWord >> 7) & 0x0f;
        const yearVal = dateWord & 0x7f;

        // FIX: Adjusted year threshold based on provided examples (e.g., 1934 vs 2025)
        // This correctly distinguishes between 20th and 21st century dates.
        const baseYear = yearVal > 30 ? 1900 : 2000;
        const year = baseYear + yearVal;

        const timeWord = (b3 << 8) | b2;
        const hour = timeWord & 0x1f;
        const minute = (timeWord >> 5) & 0x3f;

        if (
          month < 1 ||
          month > 12 ||
          day < 1 ||
          day > 31 ||
          hour > 23 ||
          minute > 59
        ) {
          console.error("Decoded date/time is out of valid range.");
          return null;
        }

        const pad = (num) => num.toString().padStart(2, "0");
        return `${pad(day)}/${pad(month)}/${year} ${pad(hour)}:${pad(minute)}`;
      }

      /**
       * Encodes a Date object into an 8-character Mifare hex string.
       * @param {Date} date - The date object to encode.
       * @returns {string|null} The 8-character hex string or null on error.
       */
      function encodeMifareDate(date) {
        if (!(date instanceof Date) || isNaN(date)) {
          console.error("Invalid input: Must be a valid Date object.");
          return null;
        }

        const day = date.getDate();
        const month = date.getMonth() + 1; // JS months are 0-11
        const yearVal = date.getFullYear() % 100; // Get last two digits of year
        const hour = date.getHours();
        const minute = date.getMinutes();

        // Build the 16-bit date word: DDDDDMMMMYYYYYYY
        const dateWord = (day << 11) | (month << 7) | yearVal;

        // Build the 16-bit time word: ?????MMMMMMHHHHH
        const timeWord = (minute << 5) | hour;

        // Extract bytes in little-endian order
        const b0 = dateWord & 0xff;
        const b1 = (dateWord >> 8) & 0xff;
        const b2 = timeWord & 0xff;
        const b3 = (timeWord >> 8) & 0xff;

        // Convert bytes to a zero-padded hex string
        const toHex = (byte) =>
          byte.toString(16).padStart(2, "0").toUpperCase();

        return `${toHex(b0)}${toHex(b1)}${toHex(b2)}${toHex(b3)}`;
      }

      function decodeAndDisplay() {
        const hexInput = document.getElementById("hexInput").value.trim();
        const resultDiv = document.getElementById("result");
        const errorDiv = document.getElementById("error");
        resultDiv.textContent = "";
        errorDiv.textContent = "";

        const decodedDate = decodeMifareDate(hexInput);
        if (decodedDate) {
          resultDiv.textContent = `Decoded Date: ${decodedDate}`;
        } else if (hexInput) {
          errorDiv.textContent =
            "Invalid hex data. Please enter a 32-character hex string.";
        }
      }

      function encodeAndDisplay() {
        const dateInput = document.getElementById("dateInput").value;
        const resultDiv = document.getElementById("encodedResult");
        const errorDiv = document.getElementById("encodeError");
        resultDiv.textContent = "";
        errorDiv.textContent = "";

        if (!dateInput) {
          errorDiv.textContent = "Please select a date and time.";
          return;
        }

        const date = new Date(dateInput);
        const encodedHex = encodeMifareDate(date);

        if (encodedHex) {
          resultDiv.textContent = `Encoded Hex: ${encodedHex}`;
        } else {
          errorDiv.textContent =
            "Could not encode the date. Please check the input.";
        }
      }

      /**
       * FIX: Sets the date input to the current local time in a robust way.
       * This avoids issues with timezones and toISOString() that can lead to incorrect dates.
       */
      function setCurrentTime() {
        const now = new Date();
        const year = now.getFullYear();
        const month = (now.getMonth() + 1).toString().padStart(2, "0");
        const day = now.getDate().toString().padStart(2, "0");
        const hours = now.getHours().toString().padStart(2, "0");
        const minutes = now.getMinutes().toString().padStart(2, "0");
        const localDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
        document.getElementById("dateInput").value = localDateTime;
      }

      // Set current time on page load
      window.onload = setCurrentTime;

      // Register service worker for PWA functionality
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("/sw.js")
            .then((registration) => {
              console.log(
                "ServiceWorker registration successful:",
                registration.scope,
              );
            })
            .catch((error) => {
              console.log("ServiceWorker registration failed:", error);
            });
        });
      }
    </script>
  </body>
</html>
